# Chronix Scheduler 

[English](./README.md) | [简体中文](./README.zh.md)

---

## 🔧 项目概览

轻量级、高性能的 C++ 定时任务调度器，支持 Cron 表达式调度、任务状态持久化、钩子回调、线程池并发执行，适用于服务端定时任务调度场景。

---

## ✨ 功能特色

- ⏱️ **Cron 表达式调度**：支持秒级精度
- 🧵 **线程池并发执行**：任务并发调度，性能强悍
- 🧩 **任务钩子机制**：支持开始、成功、结束、失败回调
- 🔄 **任务持久化**：任务状态可保存与恢复
- ⏯️ **任务控制**：支持添加、暂停、恢复、删除任务
- ⏳ **延时一次性任务**：支持延时执行一次性任务，秒级精度
- 📊 **任务指标统计**：支持任务执行次数、成功/失败次数、耗时等运行时指标，可对接 Prometheus 实时上报

---

## 🚀 使用方式

### 1. 初始化调度器

```cpp
// 初始化时指定线程池大小（例如 4 个工作线程）
auto scheduler = std::make_shared<ChronixScheduler>(4);
```

### 2. 添加定时任务

```cpp
// 每 10 秒执行一次
int job_id = scheduler.add_cron_job("*/10 * * * * *", []() { std::cout << "任务执行" << std::endl; });

scheduler->set_start_callback(job_id, [](int id) { std::cout << "任务 " << id << " 开始执行" << std::endl; });
scheduler->set_success_callback(job_id, [](int id) { std::cout << "任务 " << id << " 执行成功" << std::endl; });
scheduler->set_error_callback(job_id, [](int id, std::exception& e) { std::cerr << "任务 " << id << " 执行失败: " << e.what() << std::endl; });
// 这里可选择持久化任务状态
scheduler->set_end_callback(job_id, [](int id) { std::cout << "任务" << id << " 执行结束" << std::endl; });
```

### 3. 添加延时任务

```cpp
// 延时三秒后执行一次
scheduler->add_one_time_job(std::chrono::system_clock::now() + std::chrono::seconds(3), []() { printer("[任务2]延时3秒执行"); });
```

### 4. 控制任务状态

```cpp
scheduler.pause_job(job_id);
scheduler.resume_job(job_id);
scheduler.remove_job(job_id);
```

### 5. 任务持久化

```cpp
scheduler->set_persistence(std::make_shared<DBPersistenceMySQL<Job>>("127.0.0.1", 33036, "root", "******", "chronix"));
scheduler.save_state();     // 保存任务
scheduler.load_state();     // 恢复任务

// 恢复时需重新注册任务行为
scheduler.register_job_initializer(job_id, [](Job& job) {
    job.task = []() { std::cout << "任务重新绑定执行体" << std::endl; };
});
```

### 6. 启动调度器

```cpp
scheduler.start();
```
更详细的使用案例可查看 example/example.cpp 文件。

---

## 📊 性能压测报告

### 🧪 性能压测配置

| **配置项**         | **参数**                            |
| -------------- | ------------------------------- |
| CPU 线程数     | `std::thread::hardware_concurrency() * 4` |
| 单轮任务数     | 5000                            |
| 总轮数         | 10                              |
| 总任务数       | 50,000                           |
| 每轮运行时间   | 30 秒                           |
| 调度频率       | 每 1 ~ 5 秒（cron 表达式 `*/N * * * * *`） |
| 任务体         | 随机耗时 1 ~ 10 毫秒，10%概率失败           |

### 📈 运行结果汇总

| 轮次编号 | 总执行次数 | 成功次数 | 失败次数 | 平均耗时(ms) | 最大耗时(ms) | 最小耗时(ms) | 总耗时(s) | 吞吐量(tps)         | 成功率             | 错误率              |
|----------|------------|----------|----------|---------------|---------------|---------------|------------|----------------------|---------------------|----------------------|
| 1        | 59039      | 53037    | 6002     | 5.411         | 23            | 1             | 346.237    | 170.5161493427912    | 89.8338386490286    | 10.166161350971393   |
| 2        | 28845      | 25894    | 2951     | 5.4366        | 17            | 1             | 168.659    | 171.02556045037622   | 89.76945744496446   | 10.230542555035536   |
| 3        | 17597      | 15843    | 1754     | 5.5           | 16            | 1             | 103.127    | 170.63426648695295   | 90.03239188498038   | 9.967608115019605    |
| 4        | 12463      | 11189    | 1274     | 5.5408        | 16            | 1             | 72.697     | 171.43761090553943   | 89.77774211666532   | 10.22225788333467    |
| 5        | 10000      | 8976     | 1024     | 5.584         | 17            | 1             | 58.284     | 171.57367373550204   | 89.76               | 10.24                |
| 6        | 8806       | 7930     | 876      | 5.7072        | 15            | 1             | 51.91      | 169.63976112502408   | 90.05223711106063   | 9.94776288893936     |
| 7        | 5000       | 4477     | 523      | 5.7642        | 14            | 1             | 28.821     | 173.48461191492316   | 89.54               | 10.46                |
| 8        | 5000       | 4495     | 505      | 5.9122        | 19            | 1             | 29.561     | 169.14177463549947   | 89.9                | 10.100000000000001   |
| 9        | 5000       | 4498     | 502      | 5.852         | 16            | 1             | 29.26      | 170.88174982911826   | 89.96               | 10.040000000000001   |
| 10       | 5000       | 4481     | 519      | 5.8808        | 17            | 1             | 29.404     | 170.04489185144877   | 89.62               | 10.38                |

---

## 📄 许可协议

本项目基于 MIT License 开源使用。
